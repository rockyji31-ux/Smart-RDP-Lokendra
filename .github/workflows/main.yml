name: Ultimate RDP (Real Dark Mode Fix)

on:
  workflow_dispatch:
    inputs:
      crd_code:
        description: 'Paste Google CRD Code Here'
        required: true

jobs:
  # ==================================================
  # üêß LINUX (Real Dark Mode Logic Added)
  # ==================================================
  linux-lite:
    if: contains(github.event.inputs.crd_code, 'DISPLAY=')
    runs-on: ubuntu-latest
    timeout-minutes: 360
    steps:
      - name: üîî Notify Start
        run: |
          curl -X POST -H "Content-Type: application/json" \
          -d '{"message": "üêß *Linux Starting...*\nMode: Real Dark Theme\nWait: 45s"}' \
          ${{ secrets.N8N_WEBHOOK }} || true

      - name: ‚öôÔ∏è Install Essentials & Dark Theme
        run: |
          sudo apt-get update
          # Added 'arc-theme'
          sudo apt-get install -y --no-install-recommends xfce4 xfce4-goodies xorg dbus-x11 x11-xserver-utils pulseaudio pavucontrol xfce4-pulseaudio-plugin arc-theme
          wget https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
          sudo dpkg -i google-chrome-stable_current_amd64.deb || sudo apt-get -f install -y
          wget https://dl.google.com/linux/direct/chrome-remote-desktop_current_amd64.deb
          sudo dpkg -i chrome-remote-desktop_current_amd64.deb || sudo apt-get -f install -y

      - name: üåë Force Dark Mode (Autostart)
        run: |
          # 1. Create Autostart Directory
          mkdir -p ~/.config/autostart
          
          # 2. Create a Launcher that runs IMMEDIATELY on login
          # This forces XFCE settings to switch to Arc-Dark
          cat <<EOF > ~/.config/autostart/dark-theme.desktop
          [Desktop Entry]
          Type=Application
          Name=Force Dark Mode
          Exec=sh -c "xfconf-query -c xsettings -p /Net/ThemeName -s 'Arc-Dark' --create -t string; xfconf-query -c xfwm4 -p /general/theme -s 'Arc-Dark' --create -t string"
          StartupNotify=false
          Terminal=false
          Hidden=false
          EOF

      - name: üéß Config Audio
        run: |
          sudo usermod -a -G audio,pulse,pulse-access $USER
          
          # Standard Audio Setup
          echo "pulseaudio --start --exit-idle-time=-1" > ~/.chrome-remote-desktop-session
          echo "pactl load-module module-null-sink sink_name=DummyOutput sink_properties=device.description='Virtual_Output'" >> ~/.chrome-remote-desktop-session
          echo "exec /etc/X11/Xsession /usr/bin/xfce4-session" >> ~/.chrome-remote-desktop-session
          
          sudo apt-get install -y gnome-screensaver
          gsettings set org.gnome.desktop.lockdown disable-lock-screen 'true'

      - name: üöÄ Start RDP
        env:
          RAW_CODE: ${{ github.event.inputs.crd_code }}
        run: eval "$RAW_CODE --pin=14789147 --name=LOKENDRA-LINUX"

      - name: ‚úÖ Notify Success
        run: |
          curl -X POST -H "Content-Type: application/json" \
          -d '{"message": "üêß *LOKENDRA-LINUX Ready!*\nüîó https://remotedesktop.google.com/access\nüîë PIN: `14789147`\nüñ§ Theme: Arc-Dark (Auto-Applied)"}' \
          ${{ secrets.N8N_WEBHOOK }} || true

      - name: üí§ Keep Alive
        run: timeout 21000s bash -c "while true; do sleep 300; done" || true

  # ==================================================
  # ü™ü WINDOWS (Already Perfect)
  # ==================================================
  windows-lite:
    if: ${{ !contains(github.event.inputs.crd_code, 'DISPLAY=') }}
    runs-on: windows-latest
    timeout-minutes: 360

    steps:
      - name: üîî Notify Start
        shell: bash
        run: |
          curl -X POST -H "Content-Type: application/json" \
          -d '{"message": "ü™ü *Windows Starting...*\nWait: 2 mins"}' \
          ${{ secrets.N8N_WEBHOOK }} || true

      - name: ‚öôÔ∏è Setup Environment
        run: |
          reg add "HKLM\SOFTWARE\Policies\Microsoft\Windows NT\Terminal Services" /v "fDisableAudioCapture" /t REG_DWORD /d 0 /f
          reg add "HKLM\SOFTWARE\Policies\Microsoft\Windows NT\Terminal Services" /v "fDisableAudioPlayback" /t REG_DWORD /d 0 /f
          Invoke-WebRequest -Uri "https://dl.google.com/edgedl/chrome-remote-desktop/chromeremotedesktophost.msi" -OutFile "$env:TEMP\host.msi"
          Start-Process -FilePath msiexec.exe -ArgumentList "/i $env:TEMP\host.msi /qn /norestart" -Wait

      - name: üìù Create 'Fix_All.bat' on Desktop
        shell: powershell
        run: |
          $ScriptPath = "$env:USERPROFILE\Desktop\Fix_All.bat"
          $Content = @'
          @echo off
          Title Lokendra RDP Setup
          color 0B
          cls
          echo ==================================================
          echo      LOKENDRA RDP: ULTIMATE DARK MODE
          echo ==================================================
          echo.

          echo [1/5] Applying "Windows (dark)" Theme and Registry...
          
          :: Apply Official Dark Theme
          powershell -Command "Start-Process 'C:\Windows\Resources\Themes\dark.theme'; Start-Sleep -Seconds 3; Stop-Process -Name SystemSettings -Force -ErrorAction SilentlyContinue"

          :: Force Registry Backup
          powershell -Command "New-ItemProperty -Path HKCU:\SOFTWARE\Microsoft\Windows\CurrentVersion\Themes\Personalize -Name AppsUseLightTheme -Value 0 -Type Dword -Force; New-ItemProperty -Path HKCU:\SOFTWARE\Microsoft\Windows\CurrentVersion\Themes\Personalize -Name SystemUsesLightTheme -Value 0 -Type Dword -Force"

          :: Force Edge/Search Dark
          reg add "HKCU\Software\Policies\Microsoft\Edge" /v "PreferredColorScheme" /t REG_DWORD /d 2 /f >nul 2>&1
          reg add "HKCU\Software\Microsoft\Windows\CurrentVersion\Search" /v "SearchboxBackgroundMode" /t REG_DWORD /d 1 /f >nul 2>&1

          echo [2/5] Setting Timezone (India) and Format...
          powershell -Command "Set-TimeZone -Id 'India Standard Time'; Set-ItemProperty -Path 'HKCU:\Control Panel\International' -Name sShortTime -Value 'h:mm tt'"

          echo [3/5] Stopping Junk Services (Speed Boost)...
          powershell -Command "Stop-Service 'SysMain', 'wuauserv' -Force -ErrorAction SilentlyContinue"

          echo [4/5] Installing Audio Driver (C:\VB)...
          powershell -Command "[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12; $url = 'https://download.vb-audio.com/Download_CABLE/VBCABLE_Driver_Pack43.zip'; $dest = 'C:\VB.zip'; Invoke-WebRequest -Uri $url -OutFile $dest; Expand-Archive $dest -Dest 'C:\VB' -Force; Start-Process -FilePath 'C:\VB\VBCABLE_Setup_x64.exe' -ArgumentList '-i -h' -Verb RunAs -Wait"

          echo [5/5] Refreshing Explorer...
          powershell -Command "Get-Process explorer | Stop-Process"

          echo.
          echo ==================================================
          echo           SETUP COMPLETE! READ CAREFULLY:
          echo ==================================================
          echo.
          echo 1. Connection abhi DISCONNECT hoga (Normal hai).
          echo 2. Wapas Jao: https://remotedesktop.google.com/access
          echo 3. LOKENDRA-WINDOWS par wapas click karo.
          echo.
          echo      >>> FULL DARK THEME + AUDIO READY <<<
          echo ==================================================
          timeout /t 8

          :: Restart Services (This kills the connection)
          powershell -Command "Stop-Service Audiosrv -Force; Start-Service Audiosrv; Stop-Service chromoting -Force; Start-Service chromoting"
          '@
          Set-Content -Path $ScriptPath -Value $Content

      - name: üöÄ Start RDP
        shell: powershell
        env:
          RAW_CODE: ${{ github.event.inputs.crd_code }}
        run: |
          $code = "$env:RAW_CODE"; if ($code -match 'code="([^"]+)"') { $auth = $matches[1] } elseif ($code -match '--code ([^ ]+)') { $auth = $matches[1] }
          & "${Env:PROGRAMFILES(X86)}\Google\Chrome Remote Desktop\CurrentVersion\remoting_start_host.exe" --code="$auth" --redirect-url="https://remotedesktop.google.com/_/oauthredirect" --name="LOKENDRA-WINDOWS" --pin="14789147"

      - name: ‚úÖ Notify Success
        shell: bash
        run: |
          curl -X POST -H "Content-Type: application/json" \
          -d '{"message": "ü™ü *Windows Ready!*\nüîó https://remotedesktop.google.com/access\nüîë PIN: `14789147`\n\nüåë *Step:* Desktop par `Fix_All.bat` chalao."}' \
          ${{ secrets.N8N_WEBHOOK }} || true

      - name: üí§ Keep Alive
        shell: bash
        run: sleep 21000

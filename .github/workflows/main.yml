name: Smart RDP (Auto-Notify System)

on:
  workflow_dispatch:
    inputs:
      crd_code:
        description: 'Paste Google CRD Code Here'
        required: true

jobs:
  # ==================================================
  # ğŸ§ LINUX JOB (LOKENDRA-LINUX)
  # ==================================================
  linux-smart:
    if: contains(github.event.inputs.crd_code, 'DISPLAY=')
    runs-on: ubuntu-latest
    timeout-minutes: 360
    
    steps:
      - name: ğŸ”” Notify Start
        run: |
          curl -X POST -H "Content-Type: application/json" \
          -d '{"message": "ğŸ§ *Linux Setup Started...*\nWait 40-50 seconds."}' \
          ${{ secrets.N8N_WEBHOOK_URL }}

      - name: ğŸ§¹ 1. Smart Cleanup (Chrome Safe)
        run: |
          sudo apt-get remove -y firefox microsoft-edge-stable || true
          sudo apt-get clean

      - name: âš™ï¸ 2. Install Desktop, Chrome & Audio
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends xfce4 xfce4-goodies xorg dbus-x11 x11-xserver-utils
          sudo apt-get install -y pulseaudio pavucontrol pulseaudio-utils xfce4-pulseaudio-plugin libfuse2
          # Chrome Install
          wget https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
          sudo dpkg -i google-chrome-stable_current_amd64.deb || sudo apt-get -f install -y

      - name: ğŸ§ 3. Auto-Audio Logic
        run: |
          sudo usermod -a -G audio,pulse,pulse-access $USER
          wget https://dl.google.com/linux/direct/chrome-remote-desktop_current_amd64.deb
          sudo dpkg --install chrome-remote-desktop_current_amd64.deb || sudo apt-get -f install -y
          
          # Internal Session Audio Fix
          echo "pulseaudio --start --exit-idle-time=-1" > ~/.chrome-remote-desktop-session
          echo "pactl load-module module-null-sink sink_name=DummyOutput sink_properties=device.description='Virtual_Output'" >> ~/.chrome-remote-desktop-session
          echo "exec /etc/X11/Xsession /usr/bin/xfce4-session" >> ~/.chrome-remote-desktop-session
          
          sudo apt-get install -y gnome-screensaver
          gsettings set org.gnome.desktop.lockdown disable-lock-screen 'true'

      - name: ğŸš€ 4. Start RDP
        env:
          RAW_CODE: ${{ github.event.inputs.crd_code }}
        run: eval "$RAW_CODE --pin=14789147 --name=LOKENDRA-LINUX"

      - name: âœ… Notify Success
        run: |
          curl -X POST -H "Content-Type: application/json" \
          -d '{"message": "ğŸ§ *LOKENDRA-LINUX Ready!*\n\nğŸ”— [Connect Here](https://remotedesktop.google.com/access)\nğŸ”‘ PIN: `14789147`\nğŸ”Š Sound: Auto-Enabled"}' \
          ${{ secrets.N8N_WEBHOOK_URL }}

      - name: âŒ Notify Failure
        if: failure()
        run: |
          curl -X POST -H "Content-Type: application/json" \
          -d '{"message": "âŒ *Linux Setup Failed!* Check GitHub logs."}' \
          ${{ secrets.N8N_WEBHOOK_URL }}

      - name: ğŸ’¤ Keep Alive
        run: while true; do sleep 300; done

  # ==================================================
  # ğŸªŸ WINDOWS JOB (LOKENDRA-WINDOWS)
  # ==================================================
  windows-smart:
    if: ${{ !contains(github.event.inputs.crd_code, 'DISPLAY=') }}
    runs-on: windows-latest
    timeout-minutes: 360

    steps:
      - name: ğŸ”” Notify Start
        run: |
          curl -X POST -H "Content-Type: application/json" \
          -d '{"message": "ğŸªŸ *Windows Setup Started...*\nWait 2 minutes."}' \
          ${{ secrets.N8N_WEBHOOK_URL }}

      - name: ğŸ”“ 1. Enable Audio Registry
        run: |
          reg add "HKLM\SOFTWARE\Policies\Microsoft\Windows NT\Terminal Services" /v "fDisableAudioCapture" /t REG_DWORD /d 0 /f
          reg add "HKLM\SOFTWARE\Policies\Microsoft\Windows NT\Terminal Services" /v "fDisableAudioPlayback" /t REG_DWORD /d 0 /f

      - name: ğŸ“¥ 2. Install CRD Host Only
        run: |
          $InstallerPath = "$env:TEMP\chromeremotedesktophost.msi"
          Invoke-WebRequest -Uri "https://dl.google.com/edgedl/chrome-remote-desktop/chromeremotedesktophost.msi" -OutFile $InstallerPath
          Start-Process -FilePath msiexec.exe -ArgumentList "/i $InstallerPath /qn /norestart" -Wait

      - name: ğŸ¤– 3. Inject Auto-Run Script (Startup Folder)
        shell: powershell
        run: |
          $StartupPath = "$env:APPDATA\Microsoft\Windows\Start Menu\Programs\Startup"
          $ScriptPath = "$StartupPath\AutoFixAudio.ps1"
          
          $Content = @'
          Write-Host "ğŸš€ Auto-Fixing Audio for Lokendra..." -ForegroundColor Green
          if (-not (Test-Path "$env:TEMP\VBCABLE")) {
              $url = "https://download.vb-audio.com/Download_CABLE/VBCABLE_Driver_Pack43.zip"
              $zipPath = "$env:TEMP\VBCABLE.zip"
              $extractPath = "$env:TEMP\VBCABLE"
              Invoke-WebRequest -Uri $url -OutFile $zipPath
              Expand-Archive -Path $zipPath -DestinationPath $extractPath -Force
              Start-Process -FilePath "$extractPath\VBCABLE_Setup_x64.exe" -ArgumentList "-i -h" -Verb RunAs -Wait
          }
          Write-Host "ğŸ”„ Restarting Services..."
          Stop-Service Audiosrv -Force -ErrorAction SilentlyContinue
          Stop-Service AudioEndpointBuilder -Force -ErrorAction SilentlyContinue
          Start-Sleep -Seconds 2
          Start-Service AudioEndpointBuilder
          Start-Service Audiosrv
          Stop-Service -Name chromoting -Force -ErrorAction SilentlyContinue
          Start-Service -Name chromoting
          Write-Host "âœ… Audio Ready!"
          Start-Sleep -Seconds 3
          '@
          Set-Content -Path $ScriptPath -Value $Content

      - name: ğŸš€ 4. Start Windows RDP
        shell: powershell
        env:
          RAW_CODE: ${{ github.event.inputs.crd_code }}
        run: |
          $codeString = "$env:RAW_CODE"
          if ($codeString -match 'code="([^"]+)"') { $authCode = $matches[1] } 
          elseif ($codeString -match '--code ([^ ]+)') { $authCode = $matches[1] }
          & "${Env:PROGRAMFILES(X86)}\Google\Chrome Remote Desktop\CurrentVersion\remoting_start_host.exe" --code="$authCode" --redirect-url="https://remotedesktop.google.com/_/oauthredirect" --name="LOKENDRA-WINDOWS" --pin="14789147"

      - name: âœ… Notify Success
        run: |
          curl -X POST -H "Content-Type: application/json" \
          -d '{"message": "ğŸªŸ *LOKENDRA-WINDOWS Ready!*\n\nğŸ”— [Connect Here](https://remotedesktop.google.com/access)\nğŸ”‘ PIN: `14789147`\nğŸ’¡ *Note:* Login karte hi Audio Script chalegi, 10 sec wait karna."}' \
          ${{ secrets.N8N_WEBHOOK_URL }}

      - name: âŒ Notify Failure
        if: failure()
        run: |
          curl -X POST -H "Content-Type: application/json" \
          -d '{"message": "âŒ *Windows Setup Failed!* Check GitHub logs."}' \
          ${{ secrets.N8N_WEBHOOK_URL }}

      - name: ğŸ’¤ Keep Alive
        run: while ($true) { Start-Sleep -Seconds 300 }

name: Ultimate Smart RDP (Final Stable)

on:
  workflow_dispatch:
    inputs:
      crd_code:
        description: 'Paste Google Chrome Remote Desktop Code'
        required: true

jobs:
# ==================================================
# üêß LINUX SETUP
# ==================================================
  linux-setup:
    if: contains(github.event.inputs.crd_code, 'DISPLAY=')
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: 1Ô∏è‚É£ Cleanup
        run: |
          sudo rm -rf /usr/share/dotnet /opt/ghc /usr/local/lib/android
          sudo apt-get remove -y firefox google-chrome-stable || true
          sudo apt-get autoremove -y
          sudo apt-get clean

      - name: 2Ô∏è‚É£ Desktop + Audio
        run: |
          sudo timedatectl set-timezone Asia/Kolkata
          sudo apt-get update
          sudo apt-get install -y xfce4 xfce4-goodies xorg dbus-x11 \
            pulseaudio pavucontrol pulseaudio-utils wget curl unzip libfuse2

      - name: 3Ô∏è‚É£ Install Chrome RDP
        run: |
          wget https://dl.google.com/linux/direct/chrome-remote-desktop_current_amd64.deb
          sudo dpkg -i chrome-remote-desktop_current_amd64.deb || sudo apt -f install -y
          echo "exec /usr/bin/xfce4-session" > ~/.chrome-remote-desktop-session
          pulseaudio --start

      - name: 4Ô∏è‚É£ Start Linux RDP
        env:
          RAW_CODE: ${{ github.event.inputs.crd_code }}
        run: |
          eval "$RAW_CODE --pin=14789147 --name=LOKENDRA-LINUX"

      - name: üí§ Keep Alive
        run: while true; do sleep 300; done


# ==================================================
# ü™ü WINDOWS SETUP
# ==================================================
  windows-setup:
    if: ${{ !contains(github.event.inputs.crd_code, 'DISPLAY=') }}
    runs-on: windows-latest
    timeout-minutes: 360

    steps:
      - name: 1Ô∏è‚É£ Audio + Policy Fix (NO ERROR)
        shell: powershell
        run: |
          Set-TimeZone -Id "India Standard Time"

          reg add "HKLM\SOFTWARE\Policies\Microsoft\Windows NT\Terminal Services" /v fDisableAudioPlayback /t REG_DWORD /d 0 /f
          reg add "HKLM\SOFTWARE\Policies\Microsoft\Windows NT\Terminal Services" /v fDisableAudioCapture /t REG_DWORD /d 0 /f
          reg add "HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" /v fDisableAudioCapture /t REG_DWORD /d 0 /f

          Get-Service Audiosrv | Where-Object {$_.Status -ne "Running"} | Start-Service
          Get-Service AudioEndpointBuilder | Where-Object {$_.Status -ne "Running"} | Start-Service

      - name: 2Ô∏è‚É£ Install Chrome Remote Desktop
        shell: powershell
        run: |
          $msi="$env:TEMP\crd.msi"
          Invoke-WebRequest https://dl.google.com/edgedl/chrome-remote-desktop/chromeremotedesktophost.msi -OutFile $msi
          Start-Process msiexec.exe -ArgumentList "/i $msi /qn /norestart" -Wait

      - name: 3Ô∏è‚É£ Start Windows RDP (AUTO NAME + PIN)
        shell: powershell
        env:
          RAW_CODE: ${{ github.event.inputs.crd_code }}
        run: |
          if ($env:RAW_CODE -match 'code="([^"]+)"') {
            $CODE=$matches[1]
          } elseif ($env:RAW_CODE -match '--code ([^ ]+)') {
            $CODE=$matches[1]
          } else {
            Write-Error "Invalid CRD code"
          }

          & "${Env:PROGRAMFILES(X86)}\Google\Chrome Remote Desktop\CurrentVersion\remoting_start_host.exe" `
            --code="$CODE" `
            --redirect-url="https://remotedesktop.google.com/_/oauthredirect" `
            --name="LOKENDRA-WINDOWS" `
            --pin="14789147"

      - name: üí§ Keep Alive
        run: while ($true) { Start-Sleep 300 }

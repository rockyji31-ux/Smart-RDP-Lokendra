name: Ultimate Smart RDP (Final Stable + Apps)

on:
  workflow_dispatch:
    inputs:
      crd_code:
        description: 'Paste Google Chrome Remote Desktop Code'
        required: true

jobs:
# ==================================================
# ðŸ§ LINUX SETUP
# ==================================================
  linux-setup:
    if: contains(github.event.inputs.crd_code, 'DISPLAY=')
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: Cleanup
        run: |
          sudo rm -rf /usr/share/dotnet /opt/ghc /usr/local/lib/android
          sudo apt-get autoremove -y
          sudo apt-get clean

      - name: Desktop + Audio
        run: |
          sudo timedatectl set-timezone Asia/Kolkata
          sudo apt-get update
          sudo apt-get install -y xfce4 xfce4-goodies xorg dbus-x11 \
            pulseaudio pavucontrol wget curl unzip libfuse2

      - name: Install Sublime Text
        run: |
          wget -qO - https://download.sublimetext.com/sublimehq-pub.gpg | sudo gpg --dearmor -o /usr/share/keyrings/sublime.gpg
          echo "deb [signed-by=/usr/share/keyrings/sublime.gpg] https://download.sublimetext.com/ apt/stable/" | sudo tee /etc/apt/sources.list.d/sublime.list
          sudo apt-get update
          sudo apt-get install -y sublime-text

      - name: Install Dolphin Anty
        run: |
          mkdir -p ~/Desktop
          wget -O ~/Desktop/Dolphin-Anty.AppImage https://dolphin-anty-cdn.com/anty-app/dolphin-anty-linux-x86_64-latest.AppImage
          chmod +x ~/Desktop/Dolphin-Anty.AppImage

      - name: Install Docker
        run: |
          curl -fsSL https://get.docker.com | sh
          sudo usermod -aG docker $USER
          sudo chmod 666 /var/run/docker.sock

      - name: Install Chrome RDP
        run: |
          wget https://dl.google.com/linux/direct/chrome-remote-desktop_current_amd64.deb
          sudo dpkg -i chrome-remote-desktop_current_amd64.deb || sudo apt -f install -y
          echo "exec /usr/bin/xfce4-session" > ~/.chrome-remote-desktop-session
          pulseaudio --start

      - name: Start Linux RDP
        env:
          RAW_CODE: ${{ github.event.inputs.crd_code }}
        run: |
          eval "$RAW_CODE --pin=14789147 --name=LOKENDRA-LINUX"

      - name: Keep Alive
        run: while true; do sleep 300; done


# ==================================================
# ðŸªŸ WINDOWS SETUP
# ==================================================
  windows-setup:
    if: ${{ !contains(github.event.inputs.crd_code, 'DISPLAY=') }}
    runs-on: windows-latest
    timeout-minutes: 360

    steps:
      - name: Audio + Policy Fix
        shell: powershell
        run: |
          Set-TimeZone -Id "India Standard Time"

          reg add "HKLM\SOFTWARE\Policies\Microsoft\Windows NT\Terminal Services" /v fDisableAudioPlayback /t REG_DWORD /d 0 /f
          reg add "HKLM\SOFTWARE\Policies\Microsoft\Windows NT\Terminal Services" /v fDisableAudioCapture /t REG_DWORD /d 0 /f
          reg add "HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" /v fDisableAudioCapture /t REG_DWORD /d 0 /f

          Get-Service Audiosrv | Where-Object {$_.Status -ne "Running"} | Start-Service
          Get-Service AudioEndpointBuilder | Where-Object {$_.Status -ne "Running"} | Start-Service

      - name: Install Chrome Remote Desktop (NO HANG)
        shell: powershell
        run: |
          $msi="$env:TEMP\crd.msi"
          Invoke-WebRequest https://dl.google.com/edgedl/chrome-remote-desktop/chromeremotedesktophost.msi -OutFile $msi
          Start-Process msiexec.exe -ArgumentList "/i `"$msi`" /quiet /norestart" -NoNewWindow
          Start-Sleep 25

      - name: Install Apps (Sublime + Dolphin + Docker)
        shell: powershell
        run: |
          choco install sublimetext3 docker-desktop -y --no-progress
          $Desktop=[Environment]::GetFolderPath("Desktop")
          Invoke-WebRequest https://dolphin-anty-cdn.com/anty-app/dolphin-anty-win-latest.exe -OutFile "$Desktop\Dolphin-Anty.exe"

      - name: Start Windows RDP (AUTO NAME + PIN)
        shell: powershell
        env:
          RAW_CODE: ${{ github.event.inputs.crd_code }}
        run: |
          if ($env:RAW_CODE -match 'code="([^"]+)"') {
            $CODE=$matches[1]
          } elseif ($env:RAW_CODE -match '--code ([^ ]+)') {
            $CODE=$matches[1]
          } else {
            Write-Error "Invalid CRD code"
          }

          & "${Env:PROGRAMFILES(X86)}\Google\Chrome Remote Desktop\CurrentVersion\remoting_start_host.exe" `
            --code="$CODE" `
            --redirect-url="https://remotedesktop.google.com/_/oauthredirect" `
            --name="LOKENDRA-WINDOWS" `
            --pin="14789147"

      - name: Keep Alive
        run: while ($true) { Start-Sleep 300 }

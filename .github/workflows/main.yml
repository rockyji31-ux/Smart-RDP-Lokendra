name: Ultimate RDP (Ghost Mode + GUI Cleaner)

on:
  workflow_dispatch:
    inputs:
      crd_code:
        description: 'Paste Google CRD Code Here'
        required: true

jobs:
  # ==================================================
  # üêß LINUX JOB (Stable)
  # ==================================================
  linux-smart:
    if: contains(github.event.inputs.crd_code, 'DISPLAY=')
    runs-on: ubuntu-latest
    timeout-minutes: 360
    steps:
      - name: üîî Notify Start
        run: |
          curl -X POST -H "Content-Type: application/json" \
          -d '{"message": "üêß *Linux Setup Started...*\nName: LOKENDRA-LINUX\nWait: ~45s"}' \
          ${{ secrets.N8N_WEBHOOK }} || true
      - name: üßπ 1. Smart Cleanup
        run: |
          sudo apt-get remove -y firefox microsoft-edge-stable || true
          sudo apt-get clean
      - name: ‚öôÔ∏è 2. Install Desktop & Audio
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends xfce4 xfce4-goodies xorg dbus-x11 x11-xserver-utils
          sudo apt-get install -y pulseaudio pavucontrol pulseaudio-utils xfce4-pulseaudio-plugin libfuse2
          wget https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
          sudo dpkg -i google-chrome-stable_current_amd64.deb || sudo apt-get -f install -y
      - name: üéß 3. Auto-Audio Config
        run: |
          sudo usermod -a -G audio,pulse,pulse-access $USER
          wget https://dl.google.com/linux/direct/chrome-remote-desktop_current_amd64.deb
          sudo dpkg --install chrome-remote-desktop_current_amd64.deb || sudo apt-get -f install -y
          echo "pulseaudio --start --exit-idle-time=-1" > ~/.chrome-remote-desktop-session
          echo "pactl load-module module-null-sink sink_name=DummyOutput sink_properties=device.description='Virtual_Output'" >> ~/.chrome-remote-desktop-session
          echo "exec /etc/X11/Xsession /usr/bin/xfce4-session" >> ~/.chrome-remote-desktop-session
          sudo apt-get install -y gnome-screensaver
          gsettings set org.gnome.desktop.lockdown disable-lock-screen 'true'
      - name: üöÄ 4. Start RDP
        env:
          RAW_CODE: ${{ github.event.inputs.crd_code }}
        run: eval "$RAW_CODE --pin=14789147 --name=LOKENDRA-LINUX"
      - name: ‚úÖ Notify Success
        run: |
          curl -X POST -H "Content-Type: application/json" \
          -d '{"message": "üêß *LOKENDRA-LINUX Ready!*\n\nüîó [Connect Here](https://remotedesktop.google.com/access)\nüîë PIN: `14789147`"}' \
          ${{ secrets.N8N_WEBHOOK }} || true
      - name: üí§ Keep Alive
        run: |
          timeout 21000s bash -c "while true; do sleep 300; done" || true

  # ==================================================
  # ü™ü WINDOWS JOB (Ghost Mode & GUI Cleaner)
  # ==================================================
  windows-smart:
    if: ${{ !contains(github.event.inputs.crd_code, 'DISPLAY=') }}
    runs-on: windows-latest
    timeout-minutes: 360

    steps:
      - name: üîî Notify Start
        shell: bash
        run: |
          curl -X POST -H "Content-Type: application/json" \
          -d '{"message": "ü™ü *Windows Setup Started...*\nMode: Ghost Audio + GUI Cleaner\nWait: ~2 min"}' \
          ${{ secrets.N8N_WEBHOOK }} || true

      - name: üîì 1. Enable Audio Registry
        run: |
          reg add "HKLM\SOFTWARE\Policies\Microsoft\Windows NT\Terminal Services" /v "fDisableAudioCapture" /t REG_DWORD /d 0 /f
          reg add "HKLM\SOFTWARE\Policies\Microsoft\Windows NT\Terminal Services" /v "fDisableAudioPlayback" /t REG_DWORD /d 0 /f

      - name: üì• 2. Install CRD Host
        run: |
          $InstallerPath = "$env:TEMP\chromeremotedesktophost.msi"
          Invoke-WebRequest -Uri "https://dl.google.com/edgedl/chrome-remote-desktop/chromeremotedesktophost.msi" -OutFile $InstallerPath
          Start-Process -FilePath msiexec.exe -ArgumentList "/i $InstallerPath /qn /norestart" -Wait

      - name: ü™Ñ 3. Create Hidden Audio Fix
        shell: powershell
        run: |
          # 1. Main Logic Script (Hidden in C:)
          $AudioScriptPath = "C:\AudioFix.ps1"
          $AudioContent = @'
          if (-not (Test-Path "$env:TEMP\VBCABLE")) {
              $url = "https://download.vb-audio.com/Download_CABLE/VBCABLE_Driver_Pack43.zip"
              Invoke-WebRequest -Uri $url -OutFile "$env:TEMP\VBCABLE.zip"
              Expand-Archive -Path "$env:TEMP\VBCABLE.zip" -DestinationPath "$env:TEMP\VBCABLE" -Force
              Start-Process -FilePath "$env:TEMP\VBCABLE\VBCABLE_Setup_x64.exe" -ArgumentList "-i -h" -Verb RunAs -Wait
          }
          Stop-Service Audiosrv -Force -ErrorAction SilentlyContinue
          Start-Service Audiosrv
          Stop-Service chromoting -Force -ErrorAction SilentlyContinue
          Start-Service chromoting
          '@
          Set-Content -Path $AudioScriptPath -Value $AudioContent

          # 2. VBS Ghost Launcher (Runs logic invisibly)
          $StartupPath = "$env:APPDATA\Microsoft\Windows\Start Menu\Programs\Startup\SilentAudio.vbs"
          $VBSContent = 'CreateObject("Wscript.Shell").Run "powershell -NoProfile -ExecutionPolicy Bypass -File C:\AudioFix.ps1", 0, False'
          Set-Content -Path $StartupPath -Value $VBSContent

      - name: üßπ 4. Create "GUI Cleaner" on Desktop
        shell: powershell
        run: |
          $CleanerPath = "$env:USERPROFILE\Desktop\Super_Cleaner.ps1"
          $CleanerContent = @'
          Add-Type -AssemblyName System.Windows.Forms
          Add-Type -AssemblyName System.Drawing

          $form = New-Object System.Windows.Forms.Form
          $form.Text = "Junk Cleaner"
          $form.Size = New-Object System.Drawing.Size(300,350)
          $form.StartPosition = "CenterScreen"

          $chkVS = New-Object System.Windows.Forms.CheckBox
          $chkVS.Text = "Visual Studio (Heavy)"
          $chkVS.Location = New-Object System.Drawing.Point(20,20)
          $chkVS.AutoSize = $true
          $form.Controls.Add($chkVS)

          $chkSQL = New-Object System.Windows.Forms.CheckBox
          $chkSQL.Text = "SQL Server (Database)"
          $chkSQL.Location = New-Object System.Drawing.Point(20,50)
          $chkSQL.AutoSize = $true
          $form.Controls.Add($chkSQL)

          $chkAnd = New-Object System.Windows.Forms.CheckBox
          $chkAnd.Text = "Android SDK"
          $chkAnd.Location = New-Object System.Drawing.Point(20,80)
          $chkAnd.AutoSize = $true
          $form.Controls.Add($chkAnd)
          
          $btn = New-Object System.Windows.Forms.Button
          $btn.Text = "CLEAN SELECTED"
          $btn.Location = New-Object System.Drawing.Point(20,200)
          $btn.Size = New-Object System.Drawing.Size(200,40)
          $btn.Add_Click({
              $btn.Text = "Cleaning..."
              $btn.Enabled = $false
              
              if ($chkSQL.Checked) { 
                  Get-Service *SQL* | Stop-Service -Force -ErrorAction SilentlyContinue
                  Remove-Item "C:\Program Files\Microsoft SQL Server" -Recurse -Force -ErrorAction SilentlyContinue
              }
              if ($chkVS.Checked) { 
                  Remove-Item "C:\Program Files\Microsoft Visual Studio" -Recurse -Force -ErrorAction SilentlyContinue
                  Remove-Item "C:\Program Files (x86)\Microsoft Visual Studio" -Recurse -Force -ErrorAction SilentlyContinue
              }
              if ($chkAnd.Checked) { 
                  Remove-Item "C:\Android" -Recurse -Force -ErrorAction SilentlyContinue
              }
              
              [System.Windows.Forms.MessageBox]::Show("Cleanup Complete! RAM Freed.")
              $form.Close()
          })
          $form.Controls.Add($btn)

          $form.ShowDialog()
          '@
          Set-Content -Path $CleanerPath -Value $CleanerContent

      - name: üöÄ 5. Start Windows RDP
        shell: powershell
        env:
          RAW_CODE: ${{ github.event.inputs.crd_code }}
        run: |
          $codeString = "$env:RAW_CODE"
          if ($codeString -match 'code="([^"]+)"') { $authCode = $matches[1] } 
          elseif ($codeString -match '--code ([^ ]+)') { $authCode = $matches[1] }
          & "${Env:PROGRAMFILES(X86)}\Google\Chrome Remote Desktop\CurrentVersion\remoting_start_host.exe" --code="$authCode" --redirect-url="https://remotedesktop.google.com/_/oauthredirect" --name="LOKENDRA-WINDOWS" --pin="14789147"

      - name: ‚úÖ Notify Success
        shell: bash
        run: |
          curl -X POST -H "Content-Type: application/json" \
          -d '{"message": "ü™ü *LOKENDRA-WINDOWS Ready!*\n\nüîó [Connect Here](https://remotedesktop.google.com/access)\nüîë PIN: `14789147`\n\n1. *Audio:* Silent Auto-Fix (No Window).\n2. *Cleaner:* Desktop par `Super_Cleaner` file chalao."}' \
          ${{ secrets.N8N_WEBHOOK }} || true

      - name: üí§ Keep Alive
        shell: bash
        run: |
          sleep 21000
          curl -X POST -H "Content-Type: application/json" \
          -d '{"message": "üõë *Windows Session Expired!*\n6 Hours complete."}' \
          ${{ secrets.N8N_WEBHOOK }} || true
